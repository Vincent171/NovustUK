<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UK AI Tax Assistant</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* minimal extras kept inline for clarity */
    .sr-only { position: absolute; left: -9999px; }
    .dob-row { display: grid; grid-template-columns: 1fr 1fr 1.3fr; gap: 8px; margin: 6px 0; }
    .dob-row select {
      width: 100%; padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; background: #fff;
      -webkit-appearance: none; appearance: none;
    }
    /* Login-btn icon swap */
    #login-btn .icon-hamb { display: none; }
    #login-btn.logged-in .icon-person { display: none; }
    #login-btn.logged-in .icon-hamb { display: inline; }

    /* Email button styling (next to Copy) ‚Äî NEW */
    #email-btn {                                     /* NEW */
      position: absolute; bottom: 10px; right: 110px;/* sits left of Copy   */
      font-size: .8em; padding: 6px 12px;
      background: #10b981; color: #fff; border: none; border-radius: 4px;
      transition: opacity .2s ease, transform .05s ease;
      display: none;                                 /* shown via JS only   */
    }
    #email-btn:active { transform: translateY(1px); }/* NEW */

    /* make the auth wait overlay independent from .modal-overlay */
.auth-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.auth-overlay[hidden] { display: none !important; }

/* extra safety: ensure the spinner overlay is hidden by default */
#overlay { display: none; }

  </style>
</head>
<body>

<!-- Wait during signup/login/update details -->
<div id="auth-wait" class="auth-overlay" hidden>
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center">
    <h3 id="auth-wait-title" style="margin:0 0 6px">Just a sec‚Ä¶</h3>
    <div style="font-size:22px;letter-spacing:6px;">‚Ä¢ ‚Ä¢ ‚Ä¢</div>
  </div>
</div>



<!-- Top bar -->
<div class="topbar">
  <div class="topbar-left">
    <span id="login-status" class="hidden status-pill"></span>
  </div>

  <div class="topbar-right">
    <button id="news-btn" class="btn-outline-pill" onclick="openNews()">
      <span class="btn-ico" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="#2563eb" stroke-width="2" />
          <path d="M14 3v5h5" stroke="#2563eb" stroke-width="2"/>
          <path d="M9 13h6M9 17h6M9 9h3" stroke="#2563eb" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </span>
      <span>Latest news</span>
    </button>

    <!-- ONE button that does login (logged out) and opens menu (logged in) -->
    <div class="account-dropdown">
      <button id="login-btn" class="icon-btn" aria-label="Login / Account">
        <!-- person icon (default when logged out) -->
        <span class="icon-person" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="8" r="3.5" fill="white"></circle>
            <path d="M5 19a7 7 0 0 1 14 0" fill="white"></path>
          </svg>
        </span>
        <!-- hamburger icon (shows when logged in) -->
        <span class="icon-hamb" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="6"  width="16" height="2" fill="white"></rect>
            <rect x="4" y="11" width="16" height="2" fill="white"></rect>
            <rect x="4" y="16" width="16" height="2" fill="white"></rect>
          </svg>
        </span>
      </button>
      <div id="accountMenu" class="dropdown-menu" hidden>
        <button onclick="openModal('history')">Question History</button>
        <button onclick="openModal('account')">My Account</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div id="overlay">
    <div class="spinner"></div>
    <p id="live-timer">‚è±Ô∏è 0.00s</p>
  </div>

  <div class="header">
    <img src="logo.png" alt="Novust Logo" class="logo-crop" />
    <p class="subtext">Here to help as your AI Accountant. Ask away.</p>
  </div>

  <textarea id="questionInput" rows="5" placeholder="e.g. How much tax will I pay on ¬£30k income?
Can I claim entertaining expenses off my corporation tax?
What is the BIK on an electric car?"></textarea>

  <div style="text-align: center;">
    <button onclick="askQuestion()" id="askBtn">Ask</button>
  </div>

  <div id="answer-box">
    <div id="response">
      <div id="answer-text"></div>
      <button id="email-btn" onclick="emailMe()" title="Email this answer to me">‚úâÔ∏è Email me</button> <!-- NEW -->
      <button onclick="copyAnswer()" class="copy-btn">‚ßâ Copy</button>
    </div>
    <p id="timer"></p>
  </div>

  <div class="footer-links">
    <button class="footer-btn" onclick="openModal('privacy')">Privacy Policy</button>
    <button class="footer-btn" onclick="openModal('terms')">T&Cs</button>
  </div>
</div>

<!-- News Modal -->
<div id="news-modal" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Latest news</h3>
    <ul id="news-list"></ul>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- Signup Modal -->
<div id="signup-modal" class="modal-overlay" onclick="closeSignup(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Create Your Account</h3>
    <p>Sign up to save your replies and view your question history.</p>
    <form id="signup-form">
      <input type="text" id="fname" placeholder="First Name" required><br>
      <input type="text" id="lname" placeholder="Last Name" required><br>
      <input type="email" id="email" placeholder="Email" required><br>

      <div class="dob-row">
        <label for="dob-day" class="sr-only">Day</label>
        <select id="dob-day" required></select>
        <label for="dob-month" class="sr-only">Month</label>
        <select id="dob-month" required></select>
        <label for="dob-year" class="sr-only">Year</label>
        <select id="dob-year" required></select>
      </div>

      <input type="password" id="password" placeholder="Password" required><br>
      <button type="submit">Sign Up</button>
    </form>
    <p class="footer-link">
      <a href="#" onclick="skipSignup()">Continue without saving my replies</a>
    </p>
    <!-- NEW: link to switch to Login -->
    <p class="switch-modal-text">
      Already registered? <a href="#" onclick="switchToLogin()">Log in here</a>
    </p>
  </div>
</div>

<!-- Policy Modal -->
<div id="modal-overlay" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="modal-text" class="modal-text"></div>
    <p class="footer-link"><a href="#" onclick="closeModal()">Close</a></p>
  </div>
</div>

<!-- Login Modal -->
<div id="login-modal" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Login to Your Account to View Question History</h3>
    <form id="login-form">
      <input type="email" id="login-email" placeholder="Email" required><br>
      <input type="password" id="login-password" placeholder="Password" required><br>
      <button type="submit">Login</button>
    </form>
    <p id="login-message" style="color: red;"></p>
    <p class="switch-modal-text">
      Not registered? <a href="#" onclick="switchToSignup()">Sign up here</a>
    </p>
    <p class="footer-link"><a href="#" onclick="closeModal()">Close</a></p>
  </div>
</div>

<!-- Account Modal -->
<div id="account-modal" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Update Your Email Or Password</h3>
    <form id="email-update-form">
      <input type="password" id="current-password" placeholder="Current password" required><br>
      <input type="email" id="new-email" placeholder="New email (optional)"><br>
      <input type="password" id="new-password" placeholder="New password (optional)"><br>
      <button type="submit">Update Details</button>
    </form>
    <hr style="margin: 12px 0; opacity:.3">
    <button id="delete-account" class="danger-btn" style="background:#ef4444">Delete Account</button>
    <p id="update-status"></p>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- History Modal -->
<div id="history-modal" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 95vw;">
    <h3>My Question History</h3>
    <table id="history-table" border="1">
      <thead>
        <tr>
          <th>Question</th>
          <th>Answer</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
let useAPI = true;
let hasSignedUp = false;
let questionCount = 0;
let timerInterval, timeoutHandle;
let responseTimes = [];
const icons = ["üßæ","üí∑","üíº"];
//const TICK_MS = 200; // reduced CPU load
//NEWTIMER
const DEFAULT_TICK_MS = 200;
// allow ?tick=300 or localStorage 'tickMs'
const urlTick = new URLSearchParams(location.search).get('tick');
const TICK_MS = Number(urlTick) || Number(localStorage.getItem('tickMs')) || DEFAULT_TICK_MS;
// quick console helpers:
window.setTick = (ms)=>{ localStorage.setItem('tickMs', String(ms)); location.reload(); };
window.getTick = ()=> TICK_MS;
//ENDNEWTIMER


// Environment-aware API base
const isLocalPage =
  location.hostname === "localhost" ||
  location.hostname === "127.0.0.1" ||
  location.protocol === "file:";

const API_BASE = isLocalPage
  ? "http://localhost:3000"
  : "https://api.novust.co.uk";
  //: "https://novustuk.onrender.com";

  // (optional tiny banner so you always know which API you‚Äôre hitting)
  console.log("üîó API_BASE:", API_BASE);
  
/* Utility to verify cookie and set UI ‚Äî shows alert if blocked */
function setAuthFromUserInfoOrWarn() {
  return fetch(`${API_BASE}/user-info`, { credentials: 'include' })
    .then(r => r.ok ? r.json() : null)
    .then(u => {
      if (!u || !u.email) throw new Error('No auth cookie from server');
      localStorage.setItem("loggedInEmail", u.email);
      if (u.fname) localStorage.setItem("loggedInName", u.fname);
      updateAuthButtons();
      return u;
    })
    .catch(err => {
      console.warn('Auth cookie missing/blocked:', err);
      alert('Login/Signup succeeded but the session cookie was blocked. Please check browser cookie settings and CORS/ALLOW_ORIGINS on the API.');
      throw err;
    });
}

/*HELPERS FOR CLICKABLE LINKS IN RESPONSE*/
function escapeHtml(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function safeLinkify(text){
  // 1) escape everything
  const esc = escapeHtml(text);
  // 2) turn bare URLs into links
  return esc.replace(/(https?:\/\/[^\s)]+)(?=[)\s]|$)/g,
    '<a href="$1" target="_blank" rel="noopener nofollow">$1</a>');
}


/* ASK QUESTION */
function askQuestion() {
  try {
    const question = document.getElementById("questionInput").value.trim();
    const responseBox = document.getElementById("answer-text");
    const timerText = document.getElementById("timer");
    const overlay = document.getElementById("overlay");
    const liveTimer = document.getElementById("live-timer");
    const logo = document.querySelector('.logo-crop');

    questionCount++;
    const isLoggedIn = !!localStorage.getItem("loggedInEmail");

    if (questionCount === 2 && !hasSignedUp && !isLoggedIn) { showSignup(); return; }
    if (!question) { alert("Please enter a question."); return; }

    responseBox.textContent = "";
    document.getElementById("answer-box").style.display = "block";
    overlay.style.display = "flex";
    const start = Date.now();

    let tick = 0;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      const elapsed = ((Date.now() - start) / 1000).toFixed(2);
      const icon = icons[tick % icons.length];
      liveTimer.textContent = `${icon} ${elapsed}s`;
      tick++;
    }, TICK_MS);

    clearTimeout(timeoutHandle);
    timeoutHandle = setTimeout(() => {
      clearInterval(timerInterval);
      overlay.style.display = "none";
      responseBox.textContent = "An unexpected error occurred, please try again.";
    }, 20000);

    document.getElementById("askBtn").textContent = "Ask again";

    fetch(`${API_BASE}/api/ask`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: 'include',
      body: JSON.stringify({ question })
    })
    .then(res => res.json())
    .then(data => {
      clearInterval(timerInterval);
      clearTimeout(timeoutHandle);
      overlay.style.display = "none";

      const elapsed = ((Date.now() - start) / 1000).toFixed(2);
      responseTimes.push(elapsed);
      //responseBox.textContent = data.answer;
      responseBox.innerHTML = safeLinkify(data.answer);


      // Log Q&A (server will attach user from cookie if present)
      fetch(`${API_BASE}/log`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: 'include',
        body: JSON.stringify({ question, answer: data.answer })
      });

      responseBox.classList.add("show");
      logo.classList.add('pulse');
      setTimeout(() => logo.classList.remove('pulse'), 600);
      timerText.textContent = `‚è±Ô∏è Response time: ${elapsed}s`;

      updateEmailBtnVisibility(); // NEW
    })
    .catch(err => {
      console.error("‚ùå API call failed:", err);
      clearInterval(timerInterval);
      clearTimeout(timeoutHandle);
      overlay.style.display = "none";
      responseBox.textContent = "Failed to get a response. Please try again later.";
      updateEmailBtnVisibility(); // NEW (will hide)
    });

  } catch (error) {
    console.error("üö® Error in askQuestion():", error);
  }
}

function showSignup() { document.getElementById("signup-modal").style.display = "flex"; }
function closeSignup() { document.getElementById("signup-modal").style.display = "none"; }
function skipSignup() { closeSignup(); hasSignedUp = false; }

/* NEW: modal switchers */
function switchToSignup() { closeModal(); showSignup(); }
function switchToLogin() { closeSignup(); openModal('login'); }

function logout() {
  fetch(`${API_BASE}/logout`, { method: 'POST', credentials:'include' })
    .finally(() => {
      localStorage.removeItem("loggedInEmail");
      localStorage.removeItem("loggedInName");
      updateAuthButtons();
      updateEmailBtnVisibility(); // NEW
      alert("You‚Äôve been logged out.");
      window.location.reload();
    });
}

function copyAnswer() {
  const answerText = document.getElementById("answer-text").textContent;
  navigator.clipboard.writeText(answerText).then(() => {
    const btn = document.querySelector(".copy-btn");
    btn.classList.add("clicked");
    btn.textContent = "Copied!";
    setTimeout(() => { btn.textContent = "‚ßâ Copy"; btn.classList.remove("clicked"); }, 2000);
  });
}

/* Email this answer ‚Äî NEW */
function emailMe(){
  const isLoggedIn = !!localStorage.getItem("loggedInEmail");
  if (!isLoggedIn) { openModal('login'); return; }

  const q = document.getElementById('questionInput').value.trim();
  const a = document.getElementById('answer-text').textContent.trim();
  if (!a) return;

  const btn = document.getElementById('email-btn');
  btn.disabled = true; btn.textContent = 'Sending‚Ä¶';

  fetch(`${API_BASE}/email/me-answer`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ question: q, answer: a })
  })
  .then(r => r.json())
  .then(() => { btn.textContent = 'Sent!'; setTimeout(()=>{ btn.textContent='‚úâÔ∏è Email me'; btn.disabled=false; }, 1500); })
  .catch(() => { btn.textContent = 'Error'; setTimeout(()=>{ btn.textContent='‚úâÔ∏è Email me'; btn.disabled=false; }, 1500); });
}

function updateEmailBtnVisibility(){ // NEW
  const btn = document.getElementById('email-btn');
  if (!btn) return;
  const loggedIn = !!localStorage.getItem('loggedInEmail');
  const hasAnswer = !!document.getElementById('answer-text').textContent.trim();
  btn.style.display = (loggedIn && hasAnswer) ? 'inline-block' : 'none';
}

function openModal(type) {
  closeModal();

  if (type === "privacy") {
    document.getElementById("modal-text").innerHTML = `
      <h3>Privacy Policy</h3>
      <p>Last updated: July 2025</p>
      <p>At <strong>Novust Ltd</strong>, we take your privacy seriously. This policy outlines how we collect, use, and protect your information when using our UK AI Tax Assistant.</p>
      <h4>1. Information We Collect</h4>
      <ul>
        <li>Name, email, date of birth during sign-up.</li>
        <li>Questions you ask and the AI responses.</li>
        <li>Basic usage data for analytics and support.</li>
      </ul>
      <h4>2. How We Use Your Data</h4>
      <ul>
        <li>To provide personalised tax responses and save your history.</li>
        <li>To allow you to log in and manage your account.</li>
        <li>To improve response accuracy and quality.</li>
      </ul>
      <h4>3. Security</h4>
      <p>Passwords are <strong>hashed (bcrypt)</strong>. We do not sell your information.</p>
      <h4>4. Retention</h4>
      <p>We retain data while your account is active. You can delete your account anytime under <em>My Account</em>.</p>
      <h4>5. Your Rights</h4>
      <ul>
        <li>Access/update your information via "My Account".</li>
        <li>Request account or data deletion.</li>
      </ul>
      <p>Contact: <a href="mailto:privacy@novust.com">privacy@novust.com</a>.</p>
    `;
    document.getElementById("modal-overlay").style.display = "flex";
    return;
  }

  if (type === "terms") {
    document.getElementById("modal-text").innerHTML = `
      <h3>Terms & Conditions</h3>
      <p>Last updated: July 2025</p>
      <p>By using <strong>Novust Ltd</strong>, you agree to:</p>
      <ul>
        <li>Use the service lawfully and keep your login secure.</li>
        <li>Understand content is AI-generated guidance; confirm complex matters with HMRC/a qualified adviser.</li>
      </ul>
      <p>We may update/modify/suspend services for maintenance or security.</p>
      <p>Company content/code remain our IP.</p>
      <p>Support: <a href="mailto:support@novust.com">support@novust.com</a>.</p>
    `;
    document.getElementById("modal-overlay").style.display = "flex";
    return;
  }

  const modal = document.getElementById(`${type}-modal`);
  if (modal) { modal.style.display = "flex"; if (type === "history") loadHistory(); }
}

function closeModal(event) {
  document.querySelectorAll(".modal-overlay").forEach(m => m.style.display = "none");
  if (event) event.stopPropagation();
}

/* ‚îÄ‚îÄ Auth UI wiring ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function toggleAccountMenu(){
  const menu = document.getElementById('accountMenu');
  if (menu) menu.hidden = !menu.hidden;
}
function closeAccountMenu(){
  const menu = document.getElementById('accountMenu');
  if (menu) menu.hidden = true;
}

function updateAuthButtons() {
  const email = localStorage.getItem("loggedInEmail");
  const loggedIn = !!email;
  const loginBtn = document.getElementById("login-btn");
  const loginStatus = document.getElementById("login-status");

  if (loggedIn) {
    loginStatus.textContent = `‚úÖ Logged in as ${localStorage.getItem("loggedInName") || email}`;
    loginStatus.classList.remove("hidden");
    loginBtn.onclick = (e)=>{ e.stopPropagation(); toggleAccountMenu(); };
    loginBtn.setAttribute('aria-label','Account menu');
    loginBtn.classList.add('logged-in'); // swap to hamburger
  } else {
    loginStatus.textContent = "";
    loginStatus.classList.add("hidden");
    loginBtn.onclick = ()=> openModal('login');
    loginBtn.setAttribute('aria-label','Login');
    loginBtn.classList.remove('logged-in'); // swap back to person
    closeAccountMenu();
  }
  updateEmailBtnVisibility(); // NEW
}

// close account menu on outside click / Esc
document.addEventListener('click', (e)=>{
  const wrap = document.querySelector('.account-dropdown');
  if (wrap && !wrap.contains(e.target)) closeAccountMenu();
});
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeAccountMenu(); });

/* ‚îÄ‚îÄ Forms & init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

/* ‚îÄ‚îÄ Forms & init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener("DOMContentLoaded", () => {
  // populate DOB selects
  (function initDOB(){
    const daySel = document.getElementById("dob-day");
    const monthSel = document.getElementById("dob-month");
    const yearSel = document.getElementById("dob-year");
    if (!daySel || !monthSel || !yearSel) return;

    daySel.innerHTML = '<option value="">Day</option>' +
      Array.from({length:31},(_,i)=>`<option value="${String(i+1).padStart(2,'0')}">${i+1}</option>`).join('');
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    monthSel.innerHTML = '<option value="">Month</option>' +
      months.map((m,i)=>`<option value="${String(i+1).padStart(2,'0')}">${m}</option>`).join('');
    const thisYear = new Date().getFullYear();
    const maxY = thisYear - 16, minY = thisYear - 100;
    let yOpts = '<option value="">Year</option>';
    for (let y = maxY; y >= minY; y--) yOpts += `<option value="${y}">${y}</option>`;
    yearSel.innerHTML = yOpts;
  })();

  // Signup
  const signupForm = document.getElementById("signup-form");
  if (signupForm) {
    signupForm.addEventListener("submit", (e) => {
      e.preventDefault();
      showAuthWait('Creating your account‚Ä¶');

      const email = document.getElementById("email").value;
      const dob = (() => {
        const d = document.getElementById("dob-day").value;
        const m = document.getElementById("dob-month").value;
        const y = document.getElementById("dob-year").value;
        if (!d || !m || !y) return "";
        return `${y}-${m}-${d}`;
      })();
      const userData = {
        fname: document.getElementById("fname").value,
        lname: document.getElementById("lname").value,
        email, dob,
        password: document.getElementById("password").value,
      };

      fetch(`${API_BASE}/signup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: 'include',
        body: JSON.stringify(userData),
      })
      .then((res) => res.json())
      .then((data) => {
        if (!data.success) throw new Error(data.error || 'Signup failed');
        return setAuthFromUserInfoOrWarn().then(() => {
          closeSignup();
          askQuestion();
        });
      })
      .catch((err) => console.error("‚ùå Signup error:", err))
      .finally(() => hideAuthWait());

      // prewarm API once per session
      if (useAPI && !sessionStorage.getItem("apiWarmedUp")) {
        fetch(`${API_BASE}/api/ask`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: 'include',
          body: JSON.stringify({ question: "Hello" }),
        }).then(() => sessionStorage.setItem("apiWarmedUp","true"))
          .catch(err => console.warn("‚ö†Ô∏è Prewarm failed:", err));
      }
    });
  }

  // Login
  const loginForm = document.getElementById("login-form");
  if (loginForm) {
    loginForm.addEventListener("submit", function (e) {
      e.preventDefault();
      showAuthWait('Signing you in‚Ä¶');

      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;

      fetch(`${API_BASE}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: 'include',
        body: JSON.stringify({ email, password }),
      })
      .then((res) => res.json())
      .then((data) => {
        if (!data.success) {
          document.getElementById("login-message").textContent = "Invalid email or password.";
          return;
        }
        return setAuthFromUserInfoOrWarn()
          .then(() => { closeModal(); })
          .catch(() => { /* warning already shown in helper */ });
      })
      .catch((err) => console.error("‚ùå Login error:", err))
      .finally(() => hideAuthWait());
    });
  }

  updateAuthButtons();

  // Account form
  const emailForm = document.getElementById("email-update-form");
  if (emailForm) {
    emailForm.addEventListener("submit", function (e) {
      e.preventDefault();
      showAuthWait('Updating your account‚Ä¶');

      const password = document.getElementById("current-password").value;
      const newEmail = document.getElementById("new-email").value;
      const newPassword = document.getElementById("new-password").value;

      fetch(`${API_BASE}/update-details`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: 'include',
        body: JSON.stringify({ password, newEmail, newPassword }),
      })
      .then(res => res.text())
      .then(msg => {
        const status = document.getElementById("update-status");
        status.textContent = msg;
        if (msg.toLowerCase().includes("success")) {
          status.style.color = "green";
          if (newEmail) {
            localStorage.setItem("loggedInEmail", newEmail);
            return fetch(`${API_BASE}/user-info`, { credentials:'include' })
              .then(res => res.json())
              .then(data => {
                if (data.fname) {
                  localStorage.setItem("loggedInName", data.fname);
                  updateAuthButtons();
                }
              });
          }
        } else {
          status.style.color = "red";
        }
      })
      .catch(err => console.error('‚ùå Update details error:', err))
      .finally(() => hideAuthWait());
    });
  }

  // Delete account (keep inside DOMContentLoaded so the element exists)
  const delBtn = document.getElementById('delete-account');
  if (delBtn) {
    delBtn.addEventListener('click', () => {
      if (!confirm('This will permanently delete your account and saved history. Continue?')) return;
      fetch(`${API_BASE}/account`, { method:'DELETE', credentials:'include' })
        .then(res => res.json())
        .then(() => {
          localStorage.removeItem('loggedInEmail');
          localStorage.removeItem('loggedInName');
          alert('Account deleted.');
          window.location.reload();
        })
        .catch(()=> alert('Failed to delete account.'));
    });
  }
}); // <-- ‚úÖ closes DOMContentLoaded


// History
function loadHistory() {
  fetch(`${API_BASE}/history`, { credentials:'include' })
    .then((res) => res.json())
    .then((data) => {
      const tbody = document.querySelector("#history-table tbody");
      tbody.innerHTML = "";
      data.forEach((entry) => {
        const tr = document.createElement('tr');
        ['question','answer','timestamp'].forEach(k => {
          const td = document.createElement('td');
          td.textContent = entry[k] ?? '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    })
    .catch(()=>{
      const tbody = document.querySelector("#history-table tbody");
      tbody.innerHTML = '<tr><td colspan="3">Could not load history.</td></tr>';
    });
}

// News
async function openNews() {
  const ul = document.getElementById('news-list');
  ul.innerHTML = '<li>Loading‚Ä¶</li>';
  document.getElementById('news-modal').style.display = 'flex';
  try {
    const res = await fetch(`${API_BASE}/news`);
    const items = await res.json();
    const fmt = (d) => d ? new Date(d).toLocaleDateString('en-GB') : '';
    ul.innerHTML = items.map(i => {
      const date = fmt(i.date);
      const source = i.source ? ` (${i.source})` : '';
      return `<li><a href="${i.link}" target="_blank" rel="noopener">${i.title}</a>${source} ‚Äî ${date}</li>`;
    }).join('');
  } catch {
    ul.innerHTML = '<li>Could not load news right now.</li>';
  }
}

//function wait during signup/login/updatedetails

function showAuthWait(msg='Just a sec‚Ä¶'){
  const t = document.getElementById('auth-wait-title');
  if (t) t.textContent = msg;
  const el = document.getElementById('auth-wait');
  if (el) el.hidden = false;
}
function hideAuthWait(){
  const el = document.getElementById('auth-wait');
  if (el) el.hidden = true;
}


</script>
</body>
</html>