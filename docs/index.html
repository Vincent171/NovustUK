<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UK AI Tax Assistant</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Minimal DOB styles so it looks tidy on mobile without editing style.css */
    .sr-only { position: absolute; left: -9999px; }
    .dob-row { display: grid; grid-template-columns: 1fr 1fr 1.3fr; gap: 8px; margin: 6px 0; }
    .dob-row select {
      width: 100%; padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; background: #fff;
      -webkit-appearance: none; appearance: none;
    }
  </style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <span id="login-status" class="hidden status-pill"></span>
  </div>

  <div class="topbar-right">
    <button id="news-btn" class="btn-outline-pill" onclick="openNews()">
      <span class="btn-ico" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="#2563eb" stroke-width="2" />
          <path d="M14 3v5h5" stroke="#2563eb" stroke-width="2"/>
          <path d="M9 13h6M9 17h6M9 9h3" stroke="#2563eb" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </span>
      <span>Latest news</span>
    </button>

    <!-- Login button doubles as account menu trigger when logged in -->
    <div class="account-dropdown">
      <button id="login-btn" class="icon-btn" aria-label="Login / Account">
        <!-- Person icon (default when logged OUT) -->
        <svg class="ico-person" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="8" r="3.5" fill="white"></circle>
          <path d="M5 19a7 7 0 0 1 14 0" fill="white"></path>
        </svg>
        <!-- Hamburger (shown when logged IN) -->
        <svg class="ico-hamburger" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="6"  width="16" height="2" fill="white"></rect>
          <rect x="4" y="11" width="16" height="2" fill="white"></rect>
          <rect x="4" y="16" width="16" height="2" fill="white"></rect>
        </svg>
      </button>
      <div id="accountMenu" class="dropdown-menu" hidden>
        <button onclick="openModal('history')">Question History</button>
        <button onclick="openModal('account')">My Account</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div id="overlay">
    <div class="spinner"></div>
    <p id="live-timer">‚è±Ô∏è 0.00s</p>
  </div>

  <div class="header">
    <img src="logo.png" alt="Novust Logo" class="logo-crop" />
    <p class="subtext">Here to help as your AI Accountant. Ask away.</p>
  </div>

  <textarea id="questionInput" rows="5" placeholder="e.g. How much tax will I pay on ¬£30k self employed income?
How much tax will I pay on my rental income of ¬£24k?
Can I go over the VAT threshold without registering?
Is my employer required to offer me a pension scheme?"></textarea>

  <div style="text-align: center;">
    <button onclick="askQuestion()" id="askBtn">Ask</button>
  </div>

  <div id="answer-box">
    <div id="response">
      <div id="answer-text"></div>
      <button onclick="copyAnswer()" class="copy-btn">‚ßâ Copy</button>
    </div>
    <p id="timer"></p>
  </div>

  <div class="footer-links">
    <button class="footer-btn" onclick="openModal('privacy')">Privacy Policy</button>
    <button class="footer-btn" onclick="openModal('terms')">T&Cs</button>
  </div>
</div>

<!-- News Modal -->
<div id="news-modal" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Latest news</h3>
    <ul id="news-list"></ul>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- Signup Modal -->
<div id="signup-modal" class="modal-overlay" onclick="closeSignup(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Create Your Account</h3>
    <p>Sign up to save your replies and view your question history.</p>
    <form id="signup-form">
      <input type="text" id="fname" placeholder="First Name" required><br>
      <input type="text" id="lname" placeholder="Last Name" required><br>
      <input type="email" id="email" placeholder="Email" required><br>

      <div class="dob-row">
        <label for="dob-day" class="sr-only">Day</label>
        <select id="dob-day" required></select>
        <label for="dob-month" class="sr-only">Month</label>
        <select id="dob-month" required></select>
        <label for="dob-year" class="sr-only">Year</label>
        <select id="dob-year" required></select>
      </div>

      <input type="password" id="password" placeholder="Password" required><br>
      <button type="submit">Sign Up</button>
    </form>
    <p class="footer-link">
      <a href="#" onclick="skipSignup()">Continue without saving my replies</a>
    </p>
  </div>
</div>

<!-- Policy Modal -->
<div id="modal-overlay" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="modal-text" class="modal-text"></div>
    <p class="footer-link"><a href="#" onclick="closeModal()">Close</a></p>
  </div>
</div>

<!-- Login Modal -->
<div id="login-modal" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Login to Your Account to View Question History</h3>
    <form id="login-form">
      <input type="email" id="login-email" placeholder="Email" required><br>
      <input type="password" id="login-password" placeholder="Password" required><br>
      <button type="submit">Login</button>
    </form>
    <p id="login-message" style="color: red;"></p>
    <p class="switch-modal-text">
      Not registered? <a href="#" onclick="switchToSignup()">Sign up here</a>
    </p>
    <p class="footer-link"><a href="#" onclick="closeModal()">Close</a></p>
  </div>
</div>

<!-- Account Modal -->
<div id="account-modal" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Update Your Email Or Password</h3>
    <form id="email-update-form">
      <input type="password" id="current-password" placeholder="Current password" required><br>
      <input type="email" id="new-email" placeholder="New email (optional)"><br>
      <input type="password" id="new-password" placeholder="New password (optional)"><br>
      <button type="submit">Update Details</button>
    </form>
    <hr style="margin: 12px 0; opacity:.3">
    <button id="delete-account" class="danger-btn" style="background:#ef4444">Delete Account</button>
    <p id="update-status"></p>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- History Modal -->
<div id="history-modal" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 95vw;">
    <h3>My Question History</h3>
    <table id="history-table" border="1">
      <thead>
        <tr><th>Question</th><th>Answer</th><th>Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
let useAPI = true;
let hasSignedUp = false;
let questionCount = 0;
let timerInterval, timeoutHandle;
let responseTimes = [];
const icons = ["üßæ", "üí∑", "üíº"];
const TICK_MS = 500;

// Detect local vs deployed
const isLocalPage = location.hostname === "localhost" || location.hostname === "127.0.0.1" || location.protocol === "file:";
const API_BASE = isLocalPage ? "http://localhost:3000" : "https://novustuk.onrender.com";

/* ASK QUESTION */
function askQuestion() {
  try {
    const question = document.getElementById("questionInput").value.trim();
    const responseBox = document.getElementById("answer-text");
    const timerText = document.getElementById("timer");
    const overlay = document.getElementById("overlay");
    const liveTimer = document.getElementById("live-timer");
    const logo = document.querySelector('.logo-crop');

    questionCount++;
    const isLoggedIn = !!localStorage.getItem("loggedInEmail");

    if (questionCount === 2 && !hasSignedUp && !isLoggedIn) {
      showSignup(); return;
    }
    if (!question) { alert("Please enter a question."); return; }

    responseBox.textContent = "";
    document.getElementById("answer-box").style.display = "block";
    overlay.style.display = "flex";
    const start = Date.now();

    let tick = 0;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      const elapsed = ((Date.now() - start) / 1000).toFixed(2);
      const icon = icons[tick % icons.length];
      liveTimer.textContent = `${icon} ${elapsed}s`;
      tick++;
    }, TICK_MS);

    clearTimeout(timeoutHandle);
    timeoutHandle = setTimeout(() => {
      clearInterval(timerInterval);
      overlay.style.display = "none";
      responseBox.textContent = "An unexpected error occurred, please try again.";
    }, 20000);

    document.getElementById("askBtn").textContent = "Ask again";

    fetch(`${API_BASE}/api/ask`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: 'include',
      body: JSON.stringify({ question })
    })
    .then(res => res.json())
    .then(data => {
      clearInterval(timerInterval);
      clearTimeout(timeoutHandle);
      overlay.style.display = "none";

      const elapsed = ((Date.now() - start) / 1000).toFixed(2);
      responseTimes.push(elapsed);
      responseBox.textContent = data.answer;

      // Log Q&A (server will attach user from cookie if present)
      fetch(`${API_BASE}/log`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: 'include',
        body: JSON.stringify({ question, answer: data.answer })
      });

      responseBox.classList.add("show");
      logo.classList.add('pulse'); setTimeout(() => logo.classList.remove('pulse'), 600);
      timerText.textContent = `‚è±Ô∏è Response time: ${elapsed}s`;
    })
    .catch(err => {
      console.error("‚ùå API call failed:", err);
      clearInterval(timerInterval);
      clearTimeout(timeoutHandle);
      overlay.style.display = "none";
      responseBox.textContent = "Failed to get a response. Please try again later.";
    });

  } catch (error) { console.error("üö® Error in askQuestion():", error); }
}

function showSignup(){ document.getElementById("signup-modal").style.display = "flex"; }
function closeSignup(){ document.getElementById("signup-modal").style.display = "none"; }
function skipSignup(){ closeSignup(); hasSignedUp = false; }

function logout(){
  fetch(`${API_BASE}/logout`, { method: 'POST', credentials:'include' })
    .finally(() => {
      localStorage.removeItem("loggedInEmail");
      localStorage.removeItem("loggedInName");
      updateAuthButtons();
      alert("You‚Äôve been logged out.");
      window.location.reload();
    });
}

/* Icon swap + account menu */
function toggleAccountMenu(){
  const menu = document.getElementById('accountMenu');
  if (!menu) return;
  menu.hidden = !menu.hidden;
}
function closeAccountMenu(){
  const menu = document.getElementById('accountMenu');
  if (menu) menu.hidden = true;
}
function updateAuthButtons() {
  const email = localStorage.getItem("loggedInEmail");
  const loggedIn = !!email;
  const loginBtn = document.getElementById("login-btn");
  const loginStatus = document.getElementById("login-status");

  if (loggedIn) {
    loginStatus.textContent = `‚úÖ Logged in as ${localStorage.getItem("loggedInName") || email}`;
    loginStatus.classList.remove("hidden");

    loginBtn.classList.add("logged-in");                    // shows hamburger
    loginBtn.onclick = (e)=>{ e.stopPropagation(); toggleAccountMenu(); };
    loginBtn.setAttribute('aria-label','Account menu');
  } else {
    loginStatus.textContent = "";
    loginStatus.classList.add("hidden");

    loginBtn.classList.remove("logged-in");                 // shows person
    loginBtn.onclick = ()=> openModal('login');
    loginBtn.setAttribute('aria-label','Login');
    closeAccountMenu();
  }
}

function copyAnswer() {
  const answerText = document.getElementById("answer-text").textContent;
  navigator.clipboard.writeText(answerText).then(() => {
    const btn = document.querySelector(".copy-btn");
    btn.classList.add("clicked");
    btn.textContent = "Copied!";
    setTimeout(() => { btn.textContent = "‚ßâ Copy"; btn.classList.remove("clicked"); }, 2000);
  });
}

function openModal(type) {
  closeModal();

  if (type === "privacy") {
    document.getElementById("modal-text").innerHTML = `
      <h3>Privacy Policy</h3>
      <p>Last updated: July 2025</p>
      <p>At <strong>Novust Ltd</strong>, we take your privacy seriously. This Privacy Policy outlines how we collect, use, and protect your personal information when you use our UK AI Tax Assistant platform.</p>
      <h4>1. Information We Collect</h4>
      <ul><li>Full name, email address, and date of birth during sign-up.</li><li>Questions you ask, and the corresponding AI-generated responses.</li><li>Basic usage data (e.g. browser, device type) for analytics and support.</li></ul>
      <h4>2. How We Use Your Data</h4>
      <ul><li>To provide personalized tax responses and save your history.</li><li>To allow you to log in and manage your account.</li><li>To improve the accuracy and quality of our AI responses.</li></ul>
      <h4>3. Data Security</h4>
      <p>Your passwords are <strong>hashed (bcrypt)</strong>. We do not sell your information to third parties.</p>
      <h4>4. Data Retention</h4>
      <p>We retain your question and account data for as long as your account is active. You can delete your account anytime under <em>My Account</em>.</p>
      <h4>5. Your Rights</h4>
      <ul><li>Access or update your information via "My Account".</li><li>Request account or data deletion.</li></ul>
      <p>For any privacy-related concerns, contact <a href="mailto:privacy@novust.com">privacy@novust.com</a>.</p>
    `;
    document.getElementById("modal-overlay").style.display = "flex"; return;
  }

  if (type === "terms") {
    document.getElementById("modal-text").innerHTML = `
      <h3>Terms & Conditions</h3>
      <p>Last updated: July 2025</p>
      <p>This site provides AI-generated tax guidance and is not a substitute for formal financial or legal advice. Always consult a qualified accountant or HMRC for complex cases.</p>
      <h4>Account Usage</h4>
      <ul><li>One account per person. You are responsible for keeping your login credentials secure.</li><li>Do not use the service for illegal or abusive purposes.</li></ul>
      <h4>Accuracy & Availability</h4>
      <p>We strive for accuracy but are not liable for actions taken based on AI responses. Service may change without notice.</p>
      <p>Questions? <a href="mailto:support@novust.com">support@novust.com</a>.</p>
    `;
    document.getElementById("modal-overlay").style.display = "flex"; return;
  }

  const modal = document.getElementById(`${type}-modal`);
  if (modal) { modal.style.display = "flex"; if (type === "history") loadHistory(); }
}
function closeModal(event){ document.querySelectorAll(".modal-overlay").forEach(m => m.style.display = "none"); if (event) event.stopPropagation(); }

// Init UI + forms
document.addEventListener("DOMContentLoaded", () => {
  // Populate DOB selects
  (function initDOB(){
    const daySel = document.getElementById("dob-day");
    const monthSel = document.getElementById("dob-month");
    const yearSel = document.getElementById("dob-year");
    if (!daySel || !monthSel || !yearSel) return;
    daySel.innerHTML = '<option value="">Day</option>' + Array.from({length:31},(_,i)=>`<option value="${String(i+1).padStart(2,'0')}">${i+1}</option>`).join('');
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    monthSel.innerHTML = '<option value="">Month</option>' + months.map((m,i)=>`<option value="${String(i+1).padStart(2,'0')}">${m}</option>`).join('');
    const thisYear = new Date().getFullYear(); const maxY = thisYear - 16, minY = thisYear - 100;
    let yOpts = '<option value="">Year</option>'; for (let y = maxY; y >= minY; y--) yOpts += `<option value="${y}">${y}</option>`; yearSel.innerHTML = yOpts;
  })();

  // Signup
  const signupForm = document.getElementById("signup-form");
  if (signupForm) {
    signupForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const d = document.getElementById("dob-day").value, m = document.getElementById("dob-month").value, y = document.getElementById("dob-year").value;
      const dob = (!d||!m||!y) ? "" : `${y}-${m}-${d}`;
      const userData = {
        fname: document.getElementById("fname").value,
        lname: document.getElementById("lname").value,
        email, dob,
        password: document.getElementById("password").value,
      };
      fetch(`${API_BASE}/signup`, {
        method: "POST", headers: { "Content-Type": "application/json" }, credentials: 'include', body: JSON.stringify(userData),
      })
      .then((res) => res.json())
      .then((data) => {
        if (!data.success) throw new Error(data.error || 'Signup failed');
        localStorage.setItem("loggedInEmail", email);
        localStorage.setItem("loggedInName", userData.fname);
        closeSignup(); updateAuthButtons(); askQuestion();
      })
      .catch((err) => console.error("‚ùå Signup error:", err));
    });

    // Prewarm API
    if (useAPI && !sessionStorage.getItem("apiWarmedUp")) {
      fetch(`${API_BASE}/api/ask`, {
        method: "POST", headers: { "Content-Type": "application/json" }, credentials: 'include',
        body: JSON.stringify({ question: "Hello" }),
      }).then(() => sessionStorage.setItem("apiWarmedUp", "true")).catch(()=>{});
    }
  }

  // Login
  const loginForm = document.getElementById("login-form");
  if (loginForm) {
    loginForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      fetch(`${API_BASE}/login`, {
        method: "POST", headers: { "Content-Type": "application/json" }, credentials: 'include',
        body: JSON.stringify({ email, password }),
      })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          localStorage.setItem("loggedInEmail", email);
          localStorage.setItem("loggedInName", data.fname);
          closeModal(); updateAuthButtons();
        } else {
          document.getElementById("login-message").textContent = "Invalid email or password.";
        }
      })
      .catch((err) => console.error("‚ùå Login error:", err));
    });
  }

  // Close account menu on outside click / Esc
  document.addEventListener('click', (e)=>{
    const wrap = document.querySelector('.account-dropdown');
    if (!wrap) return;
    if (!wrap.contains(e.target)) closeAccountMenu();
  });
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeAccountMenu(); });

  updateAuthButtons();
});

function switchToSignup(){ closeModal(); document.getElementById("signup-modal").style.display = "flex"; }

// Account form
const emailForm = document.getElementById("email-update-form");
if (emailForm) {
  emailForm.addEventListener("submit", function (e) {
    e.preventDefault();
    const password = document.getElementById("current-password").value;
    const newEmail = document.getElementById("new-email").value;
    const newPassword = document.getElementById("new-password").value;
    fetch(`${API_BASE}/update-details`, {
      method: "POST", headers: { "Content-Type": "application/json" }, credentials: 'include',
      body: JSON.stringify({ password, newEmail, newPassword }),
    })
    .then(res => res.text())
    .then(msg => {
      const status = document.getElementById("update-status");
      status.textContent = msg; status.style.color = /success/i.test(msg) ? "green" : "red";
      if (/success/i.test(msg) && newEmail) {
        localStorage.setItem("loggedInEmail", newEmail);
        fetch(`${API_BASE}/user-info`, { credentials:'include' })
          .then(res => res.json())
          .then(data => { if (data.fname) { localStorage.setItem("loggedInName", data.fname); updateAuthButtons(); } });
      }
    });
  });
}

// Delete account
const delBtn = document.getElementById('delete-account');
if (delBtn) {
  delBtn.addEventListener('click', () => {
    if (!confirm('This will permanently delete your account and saved history. Continue?')) return;
    fetch(`${API_BASE}/account`, { method:'DELETE', credentials:'include' })
      .then(res => res.json())
      .then(() => { localStorage.removeItem('loggedInEmail'); localStorage.removeItem('loggedInName'); alert('Account deleted.'); window.location.reload(); })
      .catch(()=> alert('Failed to delete account.'));
  });
}

// History
function loadHistory() {
  fetch(`${API_BASE}/history`, { credentials:'include' })
    .then((res) => res.json())
    .then((data) => {
      const tbody = document.querySelector("#history-table tbody");
      tbody.innerHTML = "";
      data.forEach((entry) => {
        const tr = document.createElement('tr');
        ['question','answer','timestamp'].forEach(k => { const td = document.createElement('td'); td.textContent = entry[k] ?? ''; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
    })
    .catch(()=>{
      const tbody = document.querySelector("#history-table tbody");
      tbody.innerHTML = '<tr><td colspan="3">Could not load history.</td></tr>';
    });
}

// News
async function openNews() {
  const ul = document.getElementById('news-list');
  ul.innerHTML = '<li>Loading‚Ä¶</li>';
  document.getElementById('news-modal').style.display = 'flex';
  try {
    const res = await fetch(`${API_BASE}/news`);
    const items = await res.json();
    const fmt = (d) => d ? new Date(d).toLocaleDateString('en-GB') : '';
    ul.innerHTML = items.map(i => {
      const date = fmt(i.date); const source = i.source ? ` (${i.source})` : '';
      return `<li><a href="${i.link}" target="_blank" rel="noopener">${i.title}</a>${source} ‚Äî ${date}</li>`;
    }).join('');
  } catch { ul.innerHTML = '<li>Could not load news right now.</li>'; }
}
</script>
</body>
</html>
